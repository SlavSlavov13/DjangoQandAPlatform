{% extends "core/base.html" %}

{% block content %}
	<main>
		<div class="questions-container">
			<article class="question-detail">
				<div class="question-title-row">
					<h1 class="question-title">{{ question.title }}</h1>
					{% if user.is_authenticated and user == question.author %}
						<div class="question-edit-delete-buttons">
							<a href="{% url 'question_update' question.pk %}" class="btn btn-edit">Edit</a>
							<a href="{% url 'question_delete' question.pk %}" class="btn btn-delete">Delete</a>
						</div>
					{% endif %}
				</div>
				<p class="question-meta">
					Asked by <a href="{% url 'profile-details' question.author.pk %}">
					<strong>{{ question.author.username }}</strong></a>
					on {{ question.created_at|date:"F j, Y, g:i a" }}
				</p>
				<div class="question-body">{{ question.body|linebreaks }}</div>
				{% if question.media %}
					<div class="question-image-container">
						<img src="{{ question.media.url }}" alt="Question Image" class="question-image" />
					</div>
				{% endif %}
				{% if question.tags.all %}
					<div class="question-tags">
						<strong>Tags:</strong>
						{% for tag in question.tags.all %}
							<span class="tag">{{ tag.name }}</span>
						{% endfor %}
					</div>
				{% endif %}
				<div class="toggle-buttons">
					<button class="btn btn-comment" id="show-comments-btn" type="button" aria-controls="comments-section" aria-expanded="false" onclick="showSection('comments')">See Comments</button>
					<button class="btn btn-answer" id="show-answers-btn" type="button" aria-controls="answers-section" aria-expanded="false" onclick="showSection('answers')">See Answers</button>
				</div>
				<div class="section-header" hidden>
					<h2 id="section-heading" class="section-heading" aria-live="polite"></h2>
					{% if user.is_authenticated %}
						<a href="{% url 'add-comment-to-question' question.pk %}" class="btn btn-comment add-section-btn" id="add-comment-btn" style="display:none;">
							Add Comment
						</a>
						<a href="{% url 'create-answer' question.pk %}" class="btn btn-answer add-section-btn" id="add-answer-btn" style="display:none;">
							Add Answer
						</a>
					{% endif %}
				</div>

				<!-- Answers Section -->
				<div id="answers-section" class="content-section" aria-labelledby="section-heading" hidden>
					{% if answers %}
						<ul class="card-list">
							{% for answer in answers %}
								<li class="card-item">
									<div class="card-body">{{ answer.content|linebreaks }}</div>
									{% if answer.media %}
										<div class="answer-image-container">
											<img src="{{ answer.media.url }}" alt="Answer Image" class="answer-image" />
										</div>
									{% endif %}
									<div class="card-meta">
										by <a href="{% url 'profile-details' answer.author.pk %}">
										<strong>{{ answer.author.username }}</strong></a>
										on {{ answer.created_at|date:"F j, Y, g:i a" }}
									</div>
									{% if user.is_authenticated and user == answer.author %}
										<div class="dropdown" aria-haspopup="true" aria-expanded="false">
											<button class="dropdown-toggle" aria-label="Edit or delete answer" onclick="toggleDropdown(event)">
												&#8942;
											</button>
											<div class="dropdown-menu" hidden>
												<a href="{% url 'edit-answer' answer.pk %}" class="btn dropdown-item btn-edit">Edit</a>
												<a href="{% url 'delete-answer' answer.pk %}" class="btn dropdown-item btn-delete">Delete</a>
											</div>
										</div>
									{% endif %}
									<div class="answer-buttons-wrapper">
										<button class="btn btn-comment btn-small toggle-answer-comments-btn"
										        aria-expanded="false"
										        aria-controls="comments-for-answer-{{ answer.pk }}"
										        onclick="toggleComments('answer', {{ answer.pk }})">
											Show Comments
										</button>
										{% if request.user.is_authenticated %}
											<a href="{% url 'add-comment-to-answer' answer.pk %}"
											   class="btn btn-comment btn-small add-comment-btn"
											   id="add-comment-btn-answer-{{ answer.pk }}"
											   style="display: none;">
												Add Comment
											</a>
										{% endif %}
									</div>
									<ul class="card-list" id="comments-for-answer-{{ answer.pk }}" hidden>
										{% if answer.fetched_comments %}
											{% for comment in answer.fetched_comments %}
												<li class="card-item">
													<div class="card-body">{{ comment.content|linebreaks }}</div>
													{% if comment.media %}
														<div class="comment-image-container">
															<img src="{{ comment.media.url }}" alt="Comment Image" class="comment-image" />
														</div>
													{% endif %}
													<div class="card-meta">
														by <a href="{% url 'profile-details' comment.author.pk %}">
														<strong>{{ comment.author.username }}</strong></a>
														on {{ comment.created_at|date:"F j, Y, g:i a" }}
													</div>
													{% if user.is_authenticated and user == comment.author %}
														<div class="dropdown" aria-haspopup="true" aria-expanded="false">
															<button class="dropdown-toggle" aria-label="Edit or delete comment" onclick="toggleDropdown(event)">
																&#8942;
															</button>
															<div class="dropdown-menu" hidden>
																<a href="{% url 'edit-comment-to-answer' answer_id=answer.pk comment_id=comment.pk %}" class="btn dropdown-item btn-edit">Edit</a>
																<a href="{% url 'delete-comment-to-answer' answer_id=answer.pk comment_id=comment.pk %}" class="btn dropdown-item btn-delete">Delete</a>
															</div>
														</div>
													{% endif %}
													<div class="answer-buttons-wrapper">
														<button class="btn btn-comment btn-small toggle-comment-comments-btn"
														        aria-expanded="false"
														        aria-controls="comments-for-comment-{{ comment.pk }}"
														        onclick="toggleComments('comment', {{ comment.pk }})">
															Show Comments
														</button>
														{% if request.user.is_authenticated %}
															<a href="{% url 'add-comment-to-comment' parent_comment_id=comment.pk %}"
															   class="btn btn-comment btn-small add-comment-btn"
															   id="add-comment-btn-comment-{{ comment.pk }}"
															   style="display: none;">
																Add Comment
															</a>
														{% endif %}
													</div>
													<ul class="card-list" id="comments-for-comment-{{ comment.pk }}" hidden>
														{% if comment.fetched_child_comments %}
															{% for reply in comment.fetched_child_comments %}
																<li class="card-item">
																	<div class="card-body">{{ reply.content|linebreaks }}</div>
																	{% if reply.media %}
																		<div class="comment-image-container">
																			<img src="{{ reply.media.url }}" alt="Comment Image" class="comment-image" />
																		</div>
																	{% endif %}
																	<div class="card-meta">
																		by <a href="{% url 'profile-details' reply.author.pk %}">
																		<strong>{{ reply.author.username }}</strong></a>
																		on {{ reply.created_at|date:"F j, Y, g:i a" }}
																	</div>
																	{% if user.is_authenticated and user == reply.author %}
																		<div class="dropdown" aria-haspopup="true" aria-expanded="false">
																			<button class="dropdown-toggle" aria-label="Edit or delete comment" onclick="toggleDropdown(event)">
																				&#8942;
																			</button>
																			<div class="dropdown-menu" hidden>
																				<a href="{% url 'edit-comment-to-comment' parent_comment_id=comment.pk comment_id=reply.pk %}" class="btn dropdown-item btn-edit">Edit</a>
																				<a href="{% url 'delete-comment-to-comment' parent_comment_id=comment.pk comment_id=reply.pk %}" class="btn dropdown-item btn-delete">Delete</a>
																			</div>
																		</div>
																	{% endif %}
																</li>
															{% endfor %}
														{% else %}
															<p class="no-comments">No comments yet.</p>
														{% endif %}
													</ul>
												</li>
											{% endfor %}
										{% else %}
											<p class="no-comments">No comments yet.</p>
										{% endif %}
									</ul>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<p class="no-answers">No answers yet.</p>
					{% endif %}
				</div>

				<!-- Question Comments Section -->
				<div id="comments-section" class="content-section" aria-labelledby="section-heading" hidden>
					{% if comments %}
						<ul class="card-list">
							{% for comment in comments %}
								<li class="card-item">
									<div class="card-body">{{ comment.content|linebreaksbr }}</div>
									{% if comment.media %}
										<div class="comment-image-container">
											<img src="{{ comment.media.url }}" alt="Comment Image" class="comment-image" />
										</div>
									{% endif %}
									<div class="card-meta">
										by <a href="{% url 'profile-details' comment.author.pk %}">
										<strong>{{ comment.author.username }}</strong></a>
										on {{ comment.created_at|date:"F j, Y, g:i a" }}
									</div>
									{% if user.is_authenticated and user == comment.author %}
										<div class="dropdown" aria-haspopup="true" aria-expanded="false">
											<button class="dropdown-toggle" aria-label="Edit or delete comment" onclick="toggleDropdown(event)">
												&#8942;
											</button>
											<div class="dropdown-menu" hidden>
												<a href="{% url 'edit-comment-to-question' question_id=question.pk comment_id=comment.pk %}" class="btn dropdown-item btn-edit">Edit</a>
												<a href="{% url 'delete-comment-to-question' question_id=question.pk comment_id=comment.pk %}" class="btn dropdown-item btn-delete">Delete</a>
											</div>
										</div>
									{% endif %}
									<div class="answer-buttons-wrapper">
										<button class="btn btn-comment btn-small toggle-comment-comments-btn"
										        aria-expanded="false"
										        aria-controls="comments-for-comment-{{ comment.pk }}"
										        onclick="toggleComments('comment', {{ comment.pk }})">
											Show Comments
										</button>
										{% if user.is_authenticated %}
											<a href="{% url 'add-comment-to-comment' parent_comment_id=comment.pk %}"
											   class="btn btn-comment btn-small add-comment-btn"
											   id="add-comment-btn-comment-{{ comment.pk }}"
											   style="display: none;">
												Add Comment
											</a>
										{% endif %}
									</div>
									<ul class="card-list" id="comments-for-comment-{{ comment.pk }}" hidden>
										{% if comment.fetched_child_comments %}
											{% for reply in comment.fetched_child_comments %}
												<li class="card-item">
													<div class="card-body">{{ reply.content|linebreaks }}</div>
													{% if reply.media %}
														<div class="comment-image-container">
															<img src="{{ reply.media.url }}" alt="Comment Image" class="comment-image" />
														</div>
													{% endif %}
													<div class="card-meta">
														by <a href="{% url 'profile-details' reply.author.pk %}">
														<strong>{{ reply.author.username }}</strong></a>
														on {{ reply.created_at|date:"F j, Y, g:i a" }}
													</div>
													{% if user.is_authenticated and user == reply.author %}
														<div class="dropdown" aria-haspopup="true" aria-expanded="false">
															<button class="dropdown-toggle" aria-label="Edit or delete comment" onclick="toggleDropdown(event)">
																&#8942;
															</button>
															<div class="dropdown-menu" hidden>
																<a href="{% url 'edit-comment-to-comment' parent_comment_id=comment.pk comment_id=reply.pk %}" class="btn dropdown-item btn-edit">Edit</a>
																<a href="{% url 'delete-comment-to-comment' parent_comment_id=comment.pk comment_id=reply.pk %}" class="btn dropdown-item btn-delete">Delete</a>
															</div>
														</div>
													{% endif %}
												</li>
											{% endfor %}
										{% else %}
											<p class="no-comments">No comments yet.</p>
										{% endif %}
									</ul>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						<p class="no-comments">No comments yet.</p>
					{% endif %}
				</div>
			</article>
		</div>

		<script>
			(function() {
				const QUESTION_ID = '{{ question.pk }}';
				const STORAGE_KEY = `questionDetailsState:${QUESTION_ID}`;

				function getState() {
					let defaultState = { openTab: 'answers', expandedAnswers: [], expandedComments: [] };
					try {
						if(window.sessionStorage.getItem(STORAGE_KEY)) {
							const stored = JSON.parse(window.sessionStorage.getItem(STORAGE_KEY));
							return {...defaultState, ...stored};
						}
					} catch(e) {}
					return defaultState;
				}

				function saveState(state) {
					let cleanState = {
						openTab: state.openTab || 'answers',
						expandedAnswers: Array.from(new Set(state.expandedAnswers || [])).map(Number),
						expandedComments: Array.from(new Set(state.expandedComments || [])).map(Number),
					};
					try {
						window.sessionStorage.setItem(STORAGE_KEY, JSON.stringify(cleanState));
					} catch(e) {}
				}

				function showSection(section, restore = false) {
					const answersSection = document.getElementById('answers-section');
					const commentsSection = document.getElementById('comments-section');
					const sectionHeader = document.querySelector('.section-header');
					const heading = document.getElementById('section-heading');
					const showAnswersBtn = document.getElementById('show-answers-btn');
					const showCommentsBtn = document.getElementById('show-comments-btn');
					const addAnswerBtn = document.getElementById('add-answer-btn');
					const addCommentBtn = document.getElementById('add-comment-btn');

					answersSection.hidden = (section !== 'answers');
					commentsSection.hidden = (section !== 'comments');
					sectionHeader.hidden = false;
					heading.textContent = section === 'answers' ? 'Answers:' : 'Comments:';
					showAnswersBtn.setAttribute('aria-expanded', section === 'answers');
					showCommentsBtn.setAttribute('aria-expanded', section === 'comments');
					if(addAnswerBtn) addAnswerBtn.style.display = (section === 'answers') ? 'inline-block' : 'none';
					if(addCommentBtn) addCommentBtn.style.display = (section === 'comments') ? 'inline-block' : 'none';

					if(!restore) {
						let state = getState();
						state.openTab = section;
						saveState(state);
					}
				}
				window.showSection = (section) => showSection(section, false);

				function toggleComments(entityType, entityId, restore = false) {
					const commentsListId = `comments-for-${entityType}-${entityId}`;
					const commentsList = document.getElementById(commentsListId);
					const addCommentBtn = document.getElementById(`add-comment-btn-${entityType}-${entityId}`);
					const btnSelector = entityType === 'answer'
						? `.toggle-answer-comments-btn[aria-controls="${commentsListId}"]`
						: `.toggle-comment-comments-btn[aria-controls="${commentsListId}"]`;
					const btn = document.querySelector(btnSelector);

					if (!commentsList || !btn) return;

					if (commentsList.hidden) {
						commentsList.hidden = false;
						if (addCommentBtn) addCommentBtn.style.display = 'inline-block';
						btn.textContent = 'Hide Comments';
						btn.setAttribute('aria-expanded', 'true');

						if (!restore) addEntityIdToState(entityType, entityId);
					} else {
						commentsList.hidden = true;
						if (addCommentBtn) addCommentBtn.style.display = 'none';
						btn.textContent = 'Show Comments';
						btn.setAttribute('aria-expanded', 'false');

						if (!restore) removeEntityIdFromState(entityType, entityId);
					}
				}
				window.toggleComments = (entityType, entityId) => toggleComments(entityType, entityId, false);

				function addEntityIdToState(type, id) {
					let state = getState();
					if (type === 'answer') {
						state.expandedAnswers = Array.from(new Set([...(state.expandedAnswers || []), id]));
					} else if (type === 'comment') {
						state.expandedComments = Array.from(new Set([...(state.expandedComments || []), id]));
					}
					saveState(state);
				}

				function removeEntityIdFromState(type, id) {
					let state = getState();
					if (type === 'answer') {
						state.expandedAnswers = (state.expandedAnswers || []).filter(x => x !== id);
					} else if (type === 'comment') {
						state.expandedComments = (state.expandedComments || []).filter(x => x !== id);
					}
					saveState(state);
				}

				window.toggleDropdown = function(event) {
					event.stopPropagation();
					const button = event.currentTarget;
					const menu = button.nextElementSibling;
					const isExpanded = button.getAttribute('aria-expanded') === 'true';

					document.querySelectorAll('.dropdown-menu').forEach(m => {
						if(m !== menu) {
							m.hidden = true;
							if(m.previousElementSibling) m.previousElementSibling.setAttribute('aria-expanded', 'false');
						}
					});

					if(isExpanded){
						menu.hidden = true;
						button.setAttribute('aria-expanded', 'false');
					} else {
						menu.hidden = false;
						button.setAttribute('aria-expanded', 'true');
					}
				};

				document.addEventListener('click', () => {
					document.querySelectorAll('.dropdown-menu').forEach(menu => {
						menu.hidden = true;
					});
					document.querySelectorAll('.dropdown-toggle').forEach(button => {
						button.setAttribute('aria-expanded', 'false');
					});
				});

				document.addEventListener('DOMContentLoaded', () => {
					document.getElementById('answers-section').hidden = true;
					document.getElementById('comments-section').hidden = true;
					document.querySelector('.section-header').hidden = true;

					const addAnswerBtn = document.getElementById('add-answer-btn');
					if(addAnswerBtn) addAnswerBtn.style.display = 'none';
					const addCommentBtn = document.getElementById('add-comment-btn');
					if(addCommentBtn) addCommentBtn.style.display = 'none';

					let state = getState();
					if(!state.openTab) state.openTab = "answers";
					showSection(state.openTab, true);

					if(Array.isArray(state.expandedAnswers)){
						state.expandedAnswers.forEach(answerId => {
							if(document.getElementById(`comments-for-answer-${answerId}`)) {
								toggleComments('answer', answerId, true);
							}
						});
					}

					if(Array.isArray(state.expandedComments)){
						state.expandedComments.forEach(commentId => {
							if(document.getElementById(`comments-for-comment-${commentId}`)) {
								toggleComments('comment', commentId, true);
							}
						});
					}
				});
			})();
		</script>
	</main>
{% endblock %}
