{% extends "core/base.html" %}

{% block content %}
	<main class="profile-edit-container">
		<article class="profile-edit-article">

			<!-- Edit Profile Form -->
			<form method="post" enctype="multipart/form-data" class="profile-form">
				{% csrf_token %}
				<h2>User Info</h2>
				{% for field in user_form %}
					<div class="form-field{% if field.errors %} has-error{% endif %}">
						<label for="{{ field.id_for_label }}">{{ field.label }}</label>
						{{ field }}
						{% if field.help_text %}
							<small class="help-text">{{ field.help_text }}</small>
						{% endif %}
						{% for error in field.errors %}
							<div class="error-message">{{ error }}</div>
						{% endfor %}
					</div>

					{% if field.name == 'username' %}
						<div id="username-status" aria-live="polite" style="margin-top: -0.75em; margin-bottom: 1em; font-weight: 600;"></div>
					{% endif %}
				{% endfor %}

				<h2>Profile Info</h2>

				<!-- Avatar field: custom displayed (PRETTY, NO "Currently") -->
				<div class="form-field avatar-field">
					<label for="id_avatar">Avatar</label>
					<div class="avatar-upload-preview">
						{% if profile_form.instance.avatar %}
							<img src="{{ profile_form.instance.avatar.url }}" alt="Current avatar" class="avatar-preview-img">
						{% else %}
							<span class="avatar-img avatar-placeholder">
				          {{ profile_form.instance.user.username|first|upper }}
			        </span>
						{% endif %}
					</div>
					{{ profile_form.avatar.as_widget }}
					{% if profile_form.avatar.help_text %}
						<small class="help-text">{{ profile_form.avatar.help_text }}</small>
					{% endif %}
					{% for error in profile_form.avatar.errors %}
						<div class="error-message">{{ error }}</div>
					{% endfor %}
					{% if profile_form.avatar.field.required == False and profile_form.fields.avatar.value %}
						<div class="form-field">
							{{ profile_form.avatar_clear }} <label for="id_avatar-clear">Remove current avatar</label>
						</div>
					{% endif %}
				</div>

				{# Render rest of the profile fields (except avatar & avatar_clear) #}
				{% for field in profile_form %}
					{% if field.name != 'avatar' and field.name != 'avatar_clear' %}
						<div class="form-field{% if field.errors %} has-error{% endif %}">
							<label for="{{ field.id_for_label }}">{{ field.label }}</label>
							{{ field }}
							{% if field.help_text %}
								<small class="help-text">{{ field.help_text }}</small>
							{% endif %}
							{% for error in field.errors %}
								<div class="error-message">{{ error }}</div>
							{% endfor %}
						</div>
					{% endif %}
				{% endfor %}

				<button type="submit" name="update_profile" class="btn btn-edit">Save Profile</button>
				<a href="#" onclick="window.history.back(); return false;" class="btn btn-answer">Cancel</a>
			</form>

			<hr class="profile-edit-divider">

			<!-- Change Password Form -->
			<form method="post" class="password-form">
				{% csrf_token %}
				<h2>Change Password</h2>
				{% for field in password_form %}
					<div class="form-field{% if field.errors %} has-error{% endif %}">
						<label for="{{ field.id_for_label }}">{{ field.label }}</label>
						{{ field }}
						{% if field.help_text %}
							<small class="help-text">{{ field.help_text }}</small>
						{% endif %}
						{% for error in field.errors %}
							<div class="error-message">{{ error }}</div>
						{% endfor %}
					</div>
				{% endfor %}
				<button type="submit" name="change_password" class="btn btn-edit">Change Password</button>
				<a href="#" onclick="window.history.back(); return false;" class="btn btn-answer">Cancel</a>
				{% if not user.email %}
					<a href="#" class="btn btn-link btn-reset-pass-auto"
							{% if not user.email %} aria-disabled="true" onclick="return false;" style="opacity: 0.5; cursor: not-allowed; margin-left: 1rem;" {% endif %}
					>
						Reset your password
						<br>
						(you must have an email linked with your profile)
					</a>
				{% else %}
					<a href="{% url 'password_reset_auto' %}" class="btn btn-link btn-reset-pass-auto">
						Reset your password
					</a>
				{% endif %}
			</form>
		</article>

		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const usernameInput = document.getElementById('id_username');
				const statusDiv = document.getElementById('username-status');

				if (!usernameInput || !statusDiv) return;

				// Current logged-in username from Django context, lowercased
				const currentUsername = "{% if user.is_authenticated %}{{ user.username|escapejs }}{% else %}{% endif %}".toLowerCase();
				// The initial value inside the input on page load (could be empty)
				const initialUsername = usernameInput.value.trim().toLowerCase();

				let timeout = null;

				usernameInput.addEventListener('input', function() {
					const username = this.value.trim().toLowerCase();
					if (timeout) clearTimeout(timeout);

					timeout = setTimeout(() => {
						if (username.length === 0) {
							statusDiv.textContent = '';
							statusDiv.style.color = '';
							return;
						}

						// Show message only if user changed input and now it matches current username
						if (username === initialUsername) {
							statusDiv.textContent = 'This is your current username.';
							statusDiv.style.color = 'blue';
							return;
						}

						// AJAX request to check availability
						fetch(`/auth/ajax/check-username/?username=${encodeURIComponent(username)}`)
							.then(response => {
								if (!response.ok) throw new Error('Network response was not ok');
								return response.json();
							})
							.then(data => {
								if (data.available) {
									statusDiv.textContent = 'Username is available!';
									statusDiv.style.color = 'green';
								} else {
									statusDiv.textContent = data.error ? data.error : 'Username is taken.';
									statusDiv.style.color = 'red';
								}
							})
							.catch(() => {
								statusDiv.textContent = 'Could not check username availability.';
								statusDiv.style.color = 'gray';
							});
					}, 300);  // debounce delay 300ms
				});
			});
		</script>

	</main>
{% endblock %}
