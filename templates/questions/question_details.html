{% extends "core/base.html" %}

{% block content %}
	<main class="questions-container">
		<article class="question-detail">
			<div class="question-title-row">
				<h1 class="question-title">{{ question.title }}</h1>

				{% if user.is_authenticated and user == question.author %}
					<div class="question-edit-delete-buttons">
						<a href="{% url 'question_update' question.pk %}" class="btn btn-edit">Edit</a>
						<a href="{% url 'question_delete' question.pk %}" class="btn btn-delete">Delete</a>
					</div>
				{% endif %}
			</div>

			<p class="question-meta">
				Asked by <a href="{% url 'profile-details' question.author.pk %}">
				<strong>{{ question.author.username }}</strong></a>
				on {{ question.created_at|date:"F j, Y, g:i a" }}
			</p>

			<div class="question-body">{{ question.body|linebreaks }}</div>

			{% if question.tags.all %}
				<div class="question-tags">
					<strong>Tags:</strong>
					{% for tag in question.tags.all %}
						<span class="tag">{{ tag.name|lower|capfirst }}</span>
					{% endfor %}
				</div>
			{% endif %}

			<!-- Toggle Buttons -->
			<div class="toggle-buttons">
				<button class="btn btn-comment" id="show-comments-btn" type="button" aria-controls="comments-section" aria-expanded="false" onclick="showSection('comments')">See Comments</button>
				<button class="btn btn-answer" id="show-answers-btn" type="button" aria-controls="answers-section" aria-expanded="false" onclick="showSection('answers')">See Answers</button>
			</div>

			<!-- Section Header with heading + add button -->
			<div class="section-header" hidden>
				<h2 id="section-heading" class="section-heading" aria-live="polite"></h2>

				{% if user.is_authenticated %}
					<a href="{% url 'add_comment_to_question' question.pk %}" class="btn btn-comment add-section-btn" id="add-comment-btn" style="display:none;">
						Add Comment
					</a>
					<a href="{% url 'create-answer' question.pk %}" class="btn btn-answer add-section-btn" id="add-answer-btn" style="display:none;">
						Add Answer
					</a>
				{% endif %}
			</div>

			<!-- Answers Section -->
			<div id="answers-section" class="content-section" aria-labelledby="section-heading" hidden>
				{% if answers %}
					<ul class="card-list">
						{% for answer in answers %}
							<li class="card-item">
								<div class="card-body">{{ answer.content }}</div>
								<div class="card-meta">
									by <a href="{% url 'profile-details' answer.author.pk %}">
									<strong>{{ answer.author.username }}</strong></a>
									on {{ answer.created_at|date:"F j, Y, g:i a" }}
								</div>

								<div class="answer-buttons-wrapper">
									<button class="btn btn-comment btn-small toggle-answer-comments-btn"
									        aria-expanded="false"
									        aria-controls="comments-for-answer-{{ answer.pk }}"
									        onclick="toggleComments({{ answer.pk }})">
										Show Comments
									</button>
									<a href="{% url 'add_comment_to_answer' answer.pk %}"
									   class="btn btn-comment btn-small add-comment-btn"
									   id="add-comment-btn-{{ answer.pk }}"
									   style="display: none;">
										Add Comment
									</a>
								</div>

								<ul class="card-list" id="comments-for-answer-{{ answer.pk }}" hidden>
									{% if answer.comments.all %}
										{% for comment in answer.comments.all %}
											<li class="card-item">
												<div class="card-body">{{ comment.content|linebreaks }}</div>
												<div class="card-meta">
													by <a href="{% url 'profile-details' comment.author.pk %}">
													<strong>{{ comment.author.username }}</strong></a>
													on {{ comment.created_at|date:"F j, Y, g:i a" }}
												</div>
											</li>
										{% endfor %}
									{% else %}
										<p class="no-comments">No comments yet.</p>
									{% endif %}
								</ul>
							</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="no-answers">No answers yet.</p>
				{% endif %}
			</div>

			<!-- Question Comments Section -->
			<div id="comments-section" class="content-section" aria-labelledby="section-heading" hidden>
				{% if comments %}
					<ul class="card-list">
						{% for comment in comments %}
							<li class="card-item">
								<div class="card-body">{{ comment.content|linebreaksbr }}</div>
								<div class="card-meta">
									by <a href="{% url 'profile-details' comment.author.pk %}">
									<strong>{{ comment.author.username }}</strong></a>
									on {{ comment.created_at|date:"F j, Y, g:i a" }}
								</div>
							</li>
						{% endfor %}
					</ul>
				{% else %}
					<p class="no-comments">No comments yet.</p>
				{% endif %}
			</div>
		</article>
	</main>

	<script>
		function toggleComments(answerId) {
			const commentsList = document.getElementById(`comments-for-answer-${answerId}`);
			const addCommentBtn = document.getElementById(`add-comment-btn-${answerId}`);
			const btn = document.querySelector(`.toggle-answer-comments-btn[aria-controls="comments-for-answer-${answerId}"]`);

			if (commentsList.hidden) {
				commentsList.hidden = false;
				addCommentBtn.style.display = 'inline-block';
				btn.textContent = "Hide Comments";
				btn.setAttribute('aria-expanded', 'true');
			} else {
				commentsList.hidden = true;
				addCommentBtn.style.display = 'none';
				btn.textContent = "Show Comments";
				btn.setAttribute('aria-expanded', 'false');
			}
		}

		function showSection(section) {
			const answersSection = document.getElementById('answers-section');
			const commentsSection = document.getElementById('comments-section');
			const sectionHeader = document.querySelector('.section-header');
			const heading = document.getElementById('section-heading');
			const showAnswersBtn = document.getElementById('show-answers-btn');
			const showCommentsBtn = document.getElementById('show-comments-btn');

			const addAnswerBtn = document.getElementById('add-answer-btn');
			const addCommentBtn = document.getElementById('add-comment-btn');

			if (section === 'answers') {
				answersSection.hidden = false;
				commentsSection.hidden = true;

				sectionHeader.hidden = false;
				heading.textContent = 'Answers:';
				showAnswersBtn.setAttribute('aria-expanded', 'true');
				showCommentsBtn.setAttribute('aria-expanded', 'false');

				if (addAnswerBtn) addAnswerBtn.style.display = 'inline-block';
				if (addCommentBtn) addCommentBtn.style.display = 'none';
			} else if (section === 'comments') {
				commentsSection.hidden = false;
				answersSection.hidden = true;

				sectionHeader.hidden = false;
				heading.textContent = 'Comments:';
				showCommentsBtn.setAttribute('aria-expanded', 'true');
				showAnswersBtn.setAttribute('aria-expanded', 'false');

				if (addCommentBtn) addCommentBtn.style.display = 'inline-block';
				if (addAnswerBtn) addAnswerBtn.style.display = 'none';
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			const answersSection = document.getElementById('answers-section');
			const commentsSection = document.getElementById('comments-section');
			const sectionHeader = document.querySelector('.section-header');
			const addAnswerBtn = document.getElementById('add-answer-btn');
			const addCommentBtn = document.getElementById('add-comment-btn');

			answersSection.hidden = true;
			commentsSection.hidden = true;
			sectionHeader.hidden = true;

			if (addAnswerBtn) addAnswerBtn.style.display = 'none';
			if (addCommentBtn) addCommentBtn.style.display = 'none';
		});
	</script>
{% endblock %}
